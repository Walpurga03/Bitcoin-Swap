<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin-Tausch-Netzwerk - Login</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="styles/main.css" rel="stylesheet">
    
    <!-- Nostr Tools -->
    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
</head>
<body class="bg-dark text-light">
    
    <div class="container-fluid vh-100 d-flex align-items-center justify-content-center">
        <div class="row w-100 justify-content-center">
            <div class="col-md-6 col-lg-4">
                
                <div class="card glass-card">
                    <div class="card-header text-center">
                        <h3 class="mb-0">
                            <i class="bi bi-shield-lock text-primary"></i>
                            Bitcoin-Tausch-Netzwerk
                        </h3>
                        <p class="text-muted mt-2">Anonyme Bitcoin-Kontaktvermittlung</p>
                    </div>
                    
                    <div class="card-body">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="nsecInput" class="form-label">
                                    <i class="bi bi-key text-warning"></i> nsec (Private Key)
                                </label>
                                <div class="input-group">
                                    <input 
                                        type="password" 
                                        class="form-control" 
                                        id="nsecInput" 
                                        placeholder="nsec1..."
                                        required
                                    >
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text text-muted mt-2">
                                    <small>Demo: nsec1dxdzmrddnhdwrwpgu8sn86mtwnakqjl2g92xq3feecge52medwcquqc7hs</small>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100 mb-3" id="loginBtn">
                                <i class="bi bi-box-arrow-in-right"></i> Anmelden
                            </button>
                        </form>
                        
                        <div id="statusMessage" class="d-none"></div>
                        
                        <!-- Zugang beantragen Button -->
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-info btn-sm" onclick="requestAccess()">
                                <i class="bi bi-person-plus"></i> Zugang beantragen
                            </button>
                        </div>
                        
                        <div class="card mt-3 bg-info bg-opacity-10 border-info border-opacity-25">
                            <div class="card-body py-2">
                                <small class="text-info">
                                    <i class="bi bi-info-circle"></i>
                                    Anonyme Bitcoin-Angebote mit Interessenten-System
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const nsecInput = document.getElementById('nsecInput');
            const toggleBtn = document.getElementById('togglePassword');
            const statusDiv = document.getElementById('statusMessage');
            const loginBtn = document.getElementById('loginBtn');

            // Toggle password visibility
            toggleBtn.addEventListener('click', function() {
                const type = nsecInput.type === 'password' ? 'text' : 'password';
                nsecInput.type = type;
                const icon = toggleBtn.querySelector('i');
                icon.className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
            });

            // Login form submission
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const nsec = nsecInput.value.trim();
                
                if (!nsec.startsWith('nsec1')) {
                    showStatus('danger', 'Ung√ºltiger nsec! Muss mit "nsec1" beginnen.');
                    return;
                }

                loginBtn.disabled = true;
                loginBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Pr√ºfe Berechtigung...';

                try {
                    console.log('üîç DEBUG: Starting nsec processing...');
                    console.log('üìù Input nsec:', nsec);
                    console.log('üìè nsec length:', nsec.length);
                    console.log('üî§ nsec starts with nsec1:', nsec.startsWith('nsec1'));
                    
                    // Convert nsec to npub
                    console.log('‚öôÔ∏è Attempting to decode nsec...');
                    const decoded = window.NostrTools.nip19.decode(nsec);
                    console.log('‚úÖ Decoded successfully:', decoded);
                    
                    // Convert the private key to hex format for getPublicKey
                    const privateKeyHex = Array.from(decoded.data, byte => byte.toString(16).padStart(2, '0')).join('');
                    console.log('üîë Private key (hex):', privateKeyHex);
                    
                    // Get public key using the hex format
                    const publicKeyHex = window.NostrTools.getPublicKey(privateKeyHex);
                    console.log('üîë Public key (hex):', publicKeyHex);
                    console.log('üìè Public key length:', publicKeyHex.length);
                    
                    const npub = window.NostrTools.nip19.npubEncode(publicKeyHex);
                    console.log('üéØ Generated npub:', npub);

                    console.log('üìã Checking allowlist...');
                    console.log('üîç AUTHORIZED_MEMBERS:', AUTHORIZED_MEMBERS);
                    console.log('‚ùì Is npub in allowlist:', AUTHORIZED_MEMBERS.includes(npub));

                    // Check allowlist
                    if (AUTHORIZED_MEMBERS.includes(npub)) {
                        // Store session
                        sessionStorage.setItem('authorized_npub', npub);
                        sessionStorage.setItem('user_nsec', nsec);
                        
                        showStatus('success', 'Zugang gew√§hrt! Weiterleitung...');
                        
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1000);
                    } else {
                        showStatus('danger', `Zugang verweigert. Dein npub ist: ${npub} - Kopiere diesen und f√ºge ihn zur config.js hinzu!`);
                        console.log('Generated npub:', npub);
                        console.log('Authorized npubs:', AUTHORIZED_MEMBERS);
                        
                        // Show the npub in alert for easy copying
                        setTimeout(() => {
                            alert(`Dein npub f√ºr config.js:\n\n${npub}\n\nKopiere diesen und f√ºge ihn zur AUTHORIZED_MEMBERS Liste hinzu.`);
                        }, 1000);
                    }
                } catch (error) {
                    console.error('‚ùå ERROR Details:');
                    console.error('üìù Error message:', error.message);
                    console.error('üîç Error stack:', error.stack);
                    console.error('üì• Input nsec was:', nsec);
                    console.error('üìè Input length was:', nsec.length);
                    console.error('üî§ Input characters:', nsec.split('').map((c, i) => `${i}: '${c}'`));
                    
                    showStatus('danger', 'Fehler beim Verarbeiten des nsec: ' + error.message);
                }

                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> Anmelden';
            });

            function showStatus(type, message) {
                statusDiv.className = `alert alert-${type}`;
                statusDiv.innerHTML = `<i class="bi bi-${type === 'danger' ? 'exclamation-triangle' : 'check-circle'}"></i> ${message}`;
                statusDiv.classList.remove('d-none');
            }
        });

        function requestAccess() {
            const nsec = document.getElementById('nsecInput').value.trim();
            
            if (!nsec || !nsec.startsWith('nsec1')) {
                alert('Bitte gib erst deinen nsec ein, damit wir deinen npub f√ºr die Mitgliederliste bestimmen k√∂nnen.');
                return;
            }

            try {
                const decoded = window.NostrTools.nip19.decode(nsec);
                const publicKey = decoded.data;
                const npub = window.NostrTools.nip19.npubEncode(publicKey);
                
                const message = `Hallo! Ich m√∂chte Zugang zum Bitcoin-Tausch-Netzwerk beantragen.\\n\\nMein npub: ${npub}\\n\\nBitte f√ºge mich zur Allowlist hinzu.`;
                
                alert(`Dein npub f√ºr die Mitgliederliste:\\n\\n${npub}\\n\\nKopiere diesen npub und sende ihn an den Administrator des Bitcoin-Tausch-Netzwerks.`);
                
                // Copy to clipboard if possible
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(npub);
                }
                
            } catch (error) {
                alert('Fehler beim Konvertieren des nsec: ' + error.message);
            }
        }
    </script>
</body>
</html>
