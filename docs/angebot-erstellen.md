# üìù Angebots-System - Dokumentation

## üéØ Konzept

Ein **anonymes Angebot-System** mit maximaler Privatsph√§re:

- **Anonym:** Angebote zeigen nur Text, keine User-Identit√§t
- **Verschl√ºsselt:** Interesse-Bekundungen sind NIP-17 verschl√ºsselt
- **Privat:** Nur Angebot-Ersteller sieht, WER Interesse hat
- **Gleichberechtigt:** Admin/Whitelist-Status ist irrelevant
- **Einfach:** Nur 1 aktives Angebot pro Gruppe
- **Zeitlich begrenzt:** Angebote laufen nach 72 Stunden ab

---

## üîÑ Die 3 Phasen

### 1Ô∏è‚É£ Angebot erstellen

User klickt "Angebot erstellen" ‚Üí App generiert tempor√§ren Keypair ‚Üí User schreibt Text ‚Üí Angebot wird als **Kind 42 Event** ver√∂ffentlicht

**Besonderheit:** Angebot nutzt `temp_pubkey` statt echtem User-Pubkey ‚Üí **Anonym**

---

### 2Ô∏è‚É£ Interesse zeigen

User klickt "Interesse zeigen" ‚Üí Schreibt optionale Nachricht ‚Üí App sendet **NIP-17 verschl√ºsselte Nachricht** an `temp_pubkey`

**Besonderheit:** Doppelt verschl√ºsselt (Sealed Sender + Gift Wrap) ‚Üí Nur Angebot-Ersteller kann lesen

---

### 3Ô∏è‚É£ Interesse zur√ºckziehen

User klickt "Interesse zur√ºckziehen" ‚Üí App sendet NIP-17 Nachricht mit `type: "withdraw"`

---

## üîê Technische Details

### Nostr Event-Typen

| Event Kind | Zweck | Wer erstellt | Verschl√ºsselt |
|------------|-------|--------------|---------------|
| **Kind 42** | Angebot (Channel Message) | temp_pubkey | ‚ùå Nein (√∂ffentlich) |
| **Kind 1059** | Gift Wrap (Interesse) | ephemeral_pubkey | ‚úÖ Ja (NIP-44) |
| **Kind 14** | Sealed Sender (innere Schicht) | user_pubkey | ‚úÖ Ja (NIP-44) |
| **Kind 5** | Deletion (Angebot l√∂schen) | temp_pubkey | ‚ùå Nein |

---

### NIP-17 Gift-Wrapping Erkl√§rt

**Einfach:** Doppelte Verschl√ºsselung f√ºr maximale Privatsph√§re

```
üì¶ Gift Wrap (Kind 1059) - √Ñu√üere Schicht
  ‚îî‚îÄ Verschl√ºsselt mit Einweg-Keypair
  ‚îî‚îÄ Relay sieht NICHT wer Absender ist
      ‚îÇ
      ‚îî‚îÄ üì© Sealed Sender (Kind 14) - Innere Schicht
          ‚îî‚îÄ Verschl√ºsselt mit User-Keypair
          ‚îî‚îÄ Enth√§lt echte Nachricht + User-Identit√§t
```

**Warum 2 Schichten?**
- Relay kann keine Metadaten sammeln (wer mit wem kommuniziert)
- Nur Empf√§nger (temp_pubkey) kann beide Schichten entschl√ºsseln
- Maximale Anonymit√§t f√ºr Interesse-Bekundungen

---

### Code-Beispiele

#### Angebot erstellen (Kind 42)

```typescript
const offerEvent = {
  kind: 42,
  pubkey: tempKeypair.publicKey, // Tempor√§rer Keypair (anonym!)
  created_at: Math.floor(Date.now() / 1000),
  tags: [
    ['e', channelId, relay, 'root'],
    ['expiration', (Date.now()/1000 + 72*3600).toString()] // 72h Auto-Expire
  ],
  content: "Biete 100‚Ç¨ gegen 0.002 BTC",
};

const signed = finishEvent(offerEvent, tempKeypair.privateKey);
await pool.publish([relay], signed);

// Speichere temp_keypair (verschl√ºsselt + unverschl√ºsselt)
localStorage.setItem('marketplace_temp_keypair', JSON.stringify(tempKeypair));
const encrypted = nip44.encrypt(JSON.stringify(tempKeypair), userSharedSecret);
localStorage.setItem('marketplace_temp_keypair_encrypted', encrypted);
```

---

#### Interesse senden (NIP-17 mit NDK)

```typescript
import NDK, { NDKPrivateKeySigner, NDKEvent } from '@nostr-dev-kit/ndk';

// NDK Setup
const ndk = new NDK({ explicitRelayUrls: [relay] });
await ndk.connect();

const signer = new NDKPrivateKeySigner(userPrivateKey);
ndk.signer = signer;

// Interesse-Nachricht (NDK macht Gift-Wrapping automatisch!)
const interestMsg = new NDKEvent(ndk);
interestMsg.kind = 14; // Sealed Sender
interestMsg.content = JSON.stringify({
  type: 'interest',
  user_pubkey: userPubkey,
  user_name: userName,
  message: message,
  timestamp: Math.floor(Date.now() / 1000)
});
interestMsg.tags = [['p', tempOfferPubkey]];

await interestMsg.publish(); // NDK wrapped in Kind 1059 automatisch ‚ú®
```

---

#### Interessen laden (nur Ersteller)

```typescript
import { NDKFilter } from '@nostr-dev-kit/ndk';

async function loadInterests(ndk: NDK, tempPrivateKey: string) {
  const signer = new NDKPrivateKeySigner(tempPrivateKey);
  ndk.signer = signer;

  const filter: NDKFilter = {
    kinds: [1059], // Gift-Wrapped Messages
    '#p': [getPublicKey(tempPrivateKey)],
    limit: 100
  };

  const events = await ndk.fetchEvents(filter);
  const interests = [];

  for (const event of events) {
    // NDK entschl√ºsselt automatisch beide Schichten
    const decrypted = await event.decrypt();
    const data = JSON.parse(decrypted);
    
    if (data.type === 'interest') {
      interests.push(data);
    } else if (data.type === 'withdraw') {
      // Interesse zur√ºckgezogen
      interests = interests.filter(i => i.user_pubkey !== data.user_pubkey);
    }
  }

  return interests;
}
```

---

#### Angebot l√∂schen (Kind 5)

```typescript
const deleteEvent = {
  kind: 5,
  pubkey: getPublicKey(tempPrivateKey),
  created_at: Math.floor(Date.now() / 1000),
  tags: [['e', offerEventId]],
  content: 'Angebot zur√ºckgezogen',
};

const signed = finishEvent(deleteEvent, tempPrivateKey);
await pool.publish([relay], signed);

// Cleanup localStorage
localStorage.removeItem('marketplace_temp_keypair');
localStorage.removeItem('marketplace_temp_keypair_encrypted');
```

---

## üé® UI-Flows

### Angebot erstellen

```
[Angebot erstellen Button]
  ‚Üì
[Formular: Textfeld + Hinweis "Anonym & 72h g√ºltig"]
  ‚Üì
[Erstellen] ‚Üí Event ver√∂ffentlicht
  ‚Üì
[Angebot-Card mit "L√∂schen" + "Interessenten (0)"]
```

---

### Interesse zeigen

```
[Angebot-Card sichtbar]
  ‚Üì
[Button: "Interesse zeigen"]
  ‚Üì
[Modal: Optionale Nachricht schreiben]
  ‚Üì
[Senden] ‚Üí NIP-17 Nachricht verschickt
  ‚Üì
[Card zeigt: "‚úÖ Interesse gesendet" + "Zur√ºckziehen Button"]
```

---

### Interessenten ansehen (nur Ersteller)

```
[Angebot-Card zeigt: "Interessenten (3)"]
  ‚Üì
[Klick auf "Interessenten ansehen"]
  ‚Üì
[Modal mit Liste:]
  - Alice (@npub...) - "Nachricht..."
  - Bob (@npub...) - "Nachricht..."
  - Charlie (@npub...)
```

---

## üîí Sicherheits-Konzept

### Anonymit√§t durch temp_keypair

**Ohne:** User erstellt Angebot mit echtem Pubkey ‚Üí Jeder sieht wer es erstellt hat ‚ùå

**Mit:** User erstellt Angebot mit temp_pubkey ‚Üí Niemand wei√ü wer dahinter steckt ‚úÖ

Nur der Ersteller hat den temp_private_key ‚Üí Nur er kann l√∂schen.

---

### Privatsph√§re durch NIP-17

**Verschl√ºsselung:**
- Doppelte Schicht (Sealed Sender + Gift Wrap)
- NIP-44 Encryption (modern & sicher)
- Ephemeral Keys (einmalig verwendet)

**Metadaten-Schutz:**
- Relay sieht NICHT wer mit wem kommuniziert
- Keine Timing-Analyse m√∂glich
- Maximaler Privacy-Schutz

---

### Interesse-Counter ohne Privacy-Leak

Zeige "3 Personen haben Interesse" OHNE zu entschl√ºsseln:

```typescript
// Z√§hle nur Events, entschl√ºssele nicht
const events = await pool.querySync([relay], {
  kinds: [1059],
  '#p': [tempPubkey]
});
const count = events.length; // ‚Üê Counter
```

Nur Ersteller kann mit temp_private_key entschl√ºsseln und Identit√§ten sehen.

---

## üìä Entscheidungen

### 1. Temp-Keypair Recovery

**‚úÖ ENTSCHIEDEN:** Verschl√ºsselte Backup-Speicherung

```typescript
// Speichern (verschl√ºsselt + unverschl√ºsselt)
const encrypted = nip44.encrypt(JSON.stringify(tempKeypair), userSharedSecret);
localStorage.setItem('marketplace_temp_keypair', JSON.stringify(tempKeypair));
localStorage.setItem('marketplace_temp_keypair_encrypted', encrypted);

// Recovery bei Cache-Verlust
const encrypted = localStorage.getItem('marketplace_temp_keypair_encrypted');
if (encrypted && !localStorage.getItem('marketplace_temp_keypair')) {
  const sharedSecret = nip44.getSharedSecret(userPrivateKey, userPublicKey);
  const decrypted = nip44.decrypt(encrypted, sharedSecret);
  localStorage.setItem('marketplace_temp_keypair', decrypted);
}
```

**Vorteil:** User kann Angebot nach Cache-L√∂schung weiter verwalten.

---

### 2. NIP-17 Library

**‚úÖ ENTSCHIEDEN:** `@nostr-dev-kit/ndk`

```bash
npm install @nostr-dev-kit/ndk
```

**Vorteil:** Bew√§hrt, vollst√§ndiger NIP-17 Support, aktiv gewartet.

---

### 3. Auto-Expire

**‚úÖ ENTSCHIEDEN:** 72 Stunden (3 Tage)

```typescript
// NIP-40 expiration Tag
tags: [
  ['e', channelId, relay, 'root'],
  ['expiration', (Date.now()/1000 + 72*3600).toString()]
]

// Countdown UI
function getTimeRemaining(expiresAt: number): string {
  const remaining = expiresAt - Math.floor(Date.now() / 1000);
  if (remaining <= 0) return 'Abgelaufen';
  
  const hours = Math.floor(remaining / 3600);
  if (hours > 24) {
    const days = Math.floor(hours / 24);
    return `Noch ${days} Tag${days > 1 ? 'e' : ''}`;
  }
  return `Noch ${hours}h`;
}
```

**Vorteil:** Automatische Aufr√§umung, User sieht Dringlichkeit.

---

## üõ†Ô∏è Implementierung

### Phase 1: Temp-Keypair + Angebot erstellen

**Dateien:**
- `src/lib/nostr/crypto.ts` - generateTempKeypair()
- `src/lib/nostr/marketplace.ts` - createOffer(), deleteOffer(), loadOffers()
- `src/routes/(app)/group/+page.svelte` - UI f√ºr Angebot erstellen/l√∂schen

**Features:**
- Temp-Keypair generieren & speichern (plain + encrypted)
- Kind 42 Event erstellen mit expiration Tag (72h)
- Angebot-Card mit Countdown
- Recovery-Mechanismus (NIP-44 verschl√ºsselt mit User-NSEC)

---

### Phase 2: NIP-17 Interesse senden/empfangen

**Dateien:**
- `src/lib/nostr/nip17.ts` - sendInterest(), loadInterests(), withdrawInterest() mit NDK
- `src/lib/components/InterestModal.svelte` - Modal f√ºr Nachricht schreiben
- `src/lib/components/InterestList.svelte` - Liste der Interessenten (nur Ersteller)

**Features:**
- NDK installieren & konfigurieren
- Gift-Wrapped Messages (Kind 1059 + 14)
- Interesse-Counter (ohne Entschl√ºsselung)
- Interesse zur√ºckziehen

---

### Phase 3: Auto-Expire & Countdown

**Dateien:**
- `src/lib/utils/time.ts` - getTimeRemaining()
- `src/lib/nostr/marketplace.ts` - Auto-Delete bei Ablauf

**Features:**
- Countdown in UI ("Noch 2 Tage 15h")
- Filter: Nur nicht-abgelaufene Angebote anzeigen
- Automatisches Cleanup von abgelaufenen Angeboten

---

### Phase 4: Testing & Polish

**Tasks:**
- Error Handling (Relay-Fehler, Entschl√ºsselung fehlgeschlagen)
- Loading States (Spinner, Feedback)
- Edge Cases testen (mehrere Angebote, Cache-L√∂schung)
- Mobile-Optimierung

---

## ‚úÖ Zusammenfassung

**Das System bietet:**
- ‚úÖ Anonyme Angebote (temp_keypair)
- ‚úÖ NIP-17 verschl√ºsselte Interessen (Gift-Wrapping)
- ‚úÖ Maximale Privatsph√§re (Relay sieht keine Metadaten)
- ‚úÖ Nur Ersteller sieht Interessenten
- ‚úÖ Auto-Expire nach 72h
- ‚úÖ Recovery-Mechanismus bei Cache-Verlust

**Bereit f√ºr Implementierung!** üöÄ
