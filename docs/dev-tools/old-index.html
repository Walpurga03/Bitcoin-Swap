<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin-Gruppe - Nsec Login</title>
    
    <!-- üé® STYLES -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles/main.css">
    
    <!-- üîó ICONS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- üîê NOSTR -->
    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
</head>
<body class="bg-dark text-light">
    
    <!-- üîê LOGIN SCREEN -->
    <div id="loginScreen" class="container-fluid vh-100 d-flex align-items-center justify-content-center">
        <div class="row w-100 justify-content-center">
            <div class="col-md-6 col-lg-4">
                
                <!-- LOGIN CARD -->
                <div class="card glass-card">
                    <div class="card-header text-center bg-gradient">
                        <h4 class="mb-0">
                            <i class="bi bi-shield-lock"></i>
                            Bitcoin-Handels-Crew
                        </h4>
                        <p class="mb-0 mt-2">Private Gruppe - Nur f√ºr Mitglieder</p>
                    </div>
                    
                    <div class="card-body">
                        <!-- NSEC INPUT -->
                        <form id="nsecLoginForm">
                            <div class="mb-3">
                                <label for="nsecInput" class="form-label">
                                    <i class="bi bi-key"></i> Dein nsec (Private Key)
                                </label>
                                <div class="input-group">
                                    <input 
                                        type="password" 
                                        class="form-control" 
                                        id="nsecInput" 
                                        placeholder="nsec1..."
                                        required
                                    >
                                    <button class="btn btn-outline-secondary" type="button" id="toggleNsec">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Dein nsec wird nur lokal verwendet und nie √ºbertragen
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-gradient w-100" id="loginBtn">
                                <i class="bi bi-shield-check"></i>
                                Zugang pr√ºfen
                            </button>
                        </form>
                        
                        <!-- ERROR MESSAGE -->
                        <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i>
                            <span id="errorText"></span>
                        </div>
                        
                        <!-- SUCCESS MESSAGE -->
                        <div id="successMessage" class="alert alert-success mt-3" style="display: none;">
                            <i class="bi bi-check-circle"></i>
                            Willkommen zur√ºck! Lade Gruppe...
                        </div>
                    </div>
                    
                    <div class="card-footer text-center">
                        <small class="text-muted">
                            Noch kein Mitglied? 
                            <a href="#" onclick="showRequestAccess()" class="text-warning">
                                Zugang beantragen
                            </a>
                        </small>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- üìù REQUEST ACCESS MODAL -->
    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus"></i>
                        Zugang beantragen
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="accessRequestForm">
                        <div class="mb-3">
                            <label for="requestNpub" class="form-label">
                                <i class="bi bi-person-badge"></i> Dein npub (Public Key)
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="requestNpub" 
                                placeholder="npub1..."
                                required
                            >
                            <div class="form-text">
                                Dein √∂ffentlicher Schl√ºssel f√ºr die Identifikation
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="requestMessage" class="form-label">
                                <i class="bi bi-chat-text"></i> Nachricht an Admin
                            </label>
                            <textarea 
                                class="form-control" 
                                id="requestMessage" 
                                rows="3"
                                placeholder="Hallo! Ich m√∂chte gerne der Bitcoin-Handels-Gruppe beitreten..."
                                required
                            ></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="requestContact" class="form-label">
                                <i class="bi bi-envelope"></i> Kontakt (optional)
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="requestContact" 
                                placeholder="Telegram @username, Email, etc."
                            >
                        </div>
                        
                        <button type="submit" class="btn btn-warning w-100">
                            <i class="bi bi-send"></i>
                            Anfrage senden
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- üè¢ GROUP INTERFACE -->
    <div id="groupInterface" class="container-fluid" style="display: none;">
        
        <!-- HEADER -->
        <nav class="navbar navbar-dark bg-gradient">
            <div class="container">
                <span class="navbar-brand">
                    <i class="bi bi-shield-check text-success"></i>
                    Bitcoin-Handels-Crew
                </span>
                <div class="navbar-nav flex-row">
                    <span class="nav-item me-3">
                        <span class="badge bg-success" id="userBadge">Max_BTC</span>
                    </span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i>
                        Logout
                    </button>
                </div>
            </div>
        </nav>
        
        <!-- MAIN CONTENT -->
        <div class="container mt-4">
            <div class="row">
                
                <!-- ACTIVE OFFERS -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-currency-bitcoin"></i>
                                Aktive Bitcoin-Angebote
                            </h5>
                        </div>
                        <div class="card-body" id="offersContainer">
                            <!-- Offers will be loaded here -->
                            <div class="text-center text-muted">
                                <div class="spinner-border" role="status"></div>
                                <p class="mt-2">Lade Angebote...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SIDEBAR -->
                <div class="col-md-4">
                    
                    <!-- CREATE OFFER -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-plus-circle"></i>
                                Neues Angebot
                            </h6>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-success w-100 mb-2" onclick="createOffer('sell')">
                                <i class="bi bi-arrow-up-circle"></i>
                                Bitcoin verkaufen
                            </button>
                            <button class="btn btn-primary w-100" onclick="createOffer('buy')">
                                <i class="bi bi-arrow-down-circle"></i>
                                Bitcoin kaufen
                            </button>
                        </div>
                    </div>
                    
                    <!-- MEMBERS -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-people"></i>
                                Mitglieder <span class="badge bg-success" id="memberCount">8</span>
                            </h6>
                        </div>
                        <div class="card-body" id="membersContainer">
                            <!-- Members will be loaded here -->
                        </div>
                    </div>
                    
                </div>
                
            </div>
        </div>
        
    </div>

    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .bg-gradient {
            background: linear-gradient(135deg, #6b46c1, #8b5cf6) !important;
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #6b46c1, #8b5cf6);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            background: linear-gradient(135deg, #553c9a, #7c3aed);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107, 70, 193, 0.4);
        }
        
        .offer-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .offer-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .member-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .status-online {
            color: #28a745;
        }
        
        .status-offline {
            color: #6c757d;
        }
    </style>

    <script>
        // üîê ALLOWLIST - Authorized Members (npub format)
        const AUTHORIZED_MEMBERS = [
            'npub1max...example1',  // Max - Bitcoin OG
            'npub1lisa...example2', // Lisa - Lightning Expert  
            'npub1tom...example3',  // Tom - Hodler
            'npub1sarah...example4', // Sarah - DeFi Queen
            'npub1mike...example5',  // Mike - Miner
            'npub1admin...example6', // Admin
            // Add more authorized npubs here
        ];
        
        // üë• DEMO MEMBERS DATA
        const DEMO_MEMBERS = [
            { npub: 'npub1max...example1', name: 'Max_BTC', status: 'online', lastSeen: 'jetzt' },
            { npub: 'npub1lisa...example2', name: 'Lisa_Lightning', status: 'online', lastSeen: 'vor 5 Min' },
            { npub: 'npub1tom...example3', name: 'Tom_Hodler', status: 'offline', lastSeen: 'vor 2 Std' },
            { npub: 'npub1sarah...example4', name: 'Sarah_DeFi', status: 'online', lastSeen: 'vor 1 Min' },
            { npub: 'npub1mike...example5', name: 'Mike_Miner', status: 'offline', lastSeen: 'vor 30 Min' }
        ];
        
        // üí∞ DEMO OFFERS DATA
        const DEMO_OFFERS = [
            {
                id: 1,
                type: 'sell',
                user: 'Lisa_Lightning',
                amount: 0.1,
                price: 2800,
                currency: 'EUR',
                method: 'Bank Transfer',
                created: 'vor 15 Min'
            },
            {
                id: 2,
                type: 'buy',
                user: 'Tom_Hodler', 
                amount: 0.05,
                price: 2850,
                currency: 'EUR',
                method: 'Cash (M√ºnchen)',
                created: 'vor 1 Std'
            },
            {
                id: 3,
                type: 'sell',
                user: 'Mike_Miner',
                amount: 0.25,
                price: 2820,
                currency: 'EUR', 
                method: 'SEPA Instant',
                created: 'vor 3 Std'
            }
        ];
        
        let currentUser = null;
        
        // üöÄ Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            const savedNpub = localStorage.getItem('userNpub');
            if (savedNpub && isAuthorized(savedNpub)) {
                currentUser = { npub: savedNpub };
                showGroupInterface();
            }
            
            // Setup event listeners
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Nsec login form
            document.getElementById('nsecLoginForm').addEventListener('submit', handleNsecLogin);
            
            // Toggle nsec visibility
            document.getElementById('toggleNsec').addEventListener('click', toggleNsecVisibility);
            
            // Access request form
            document.getElementById('accessRequestForm').addEventListener('submit', handleAccessRequest);
        }
        
        async function handleNsecLogin(event) {
            event.preventDefault();
            
            const nsecInput = document.getElementById('nsecInput');
            const nsec = nsecInput.value.trim();
            
            // Validate nsec format
            if (!nsec.startsWith('nsec1') || nsec.length !== 63) {
                showError('Ung√ºltiges nsec Format. Muss mit "nsec1" beginnen und 63 Zeichen lang sein.');
                return;
            }
            
            try {
                // Convert nsec to npub using nostr-tools
                const privateKeyHex = window.NostrTools.nip19.decode(nsec).data;
                const publicKeyHex = window.NostrTools.getPublicKey(privateKeyHex);
                const npub = window.NostrTools.nip19.npubEncode(publicKeyHex);
                
                console.log('üîê Login attempt:', { nsec: nsec.substring(0, 10) + '...', npub: npub.substring(0, 15) + '...' });
                
                // Check if npub is authorized
                if (isAuthorized(npub)) {
                    // Success! Store user and show interface
                    currentUser = { 
                        npub: npub,
                        privateKey: privateKeyHex,
                        nsec: nsec
                    };
                    
                    localStorage.setItem('userNpub', npub);
                    
                    showSuccess();
                    setTimeout(() => {
                        showGroupInterface();
                    }, 1500);
                    
                } else {
                    showError('Zugang verweigert. Dein npub ist nicht in der Mitgliederliste. Beantrage Zugang √ºber "Zugang beantragen".');
                }
                
            } catch (error) {
                console.error('‚ùå Login error:', error);
                showError('Fehler beim Verarbeiten des nsec. Bitte √ºberpr√ºfe das Format.');
            }
        }
        
        function isAuthorized(npub) {
            // Check if npub is in authorized list
            return AUTHORIZED_MEMBERS.includes(npub);
        }
        
        function toggleNsecVisibility() {
            const nsecInput = document.getElementById('nsecInput');
            const toggleBtn = document.getElementById('toggleNsec');
            
            if (nsecInput.type === 'password') {
                nsecInput.type = 'text';
                toggleBtn.innerHTML = '<i class="bi bi-eye-slash"></i>';
            } else {
                nsecInput.type = 'password';
                toggleBtn.innerHTML = '<i class="bi bi-eye"></i>';
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showSuccess() {
            const successDiv = document.getElementById('successMessage');
            successDiv.style.display = 'block';
        }
        
        function showGroupInterface() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('groupInterface').style.display = 'block';
            
            // Load group data
            loadOffers();
            loadMembers();
            updateUserBadge();
        }
        
        function loadOffers() {
            const container = document.getElementById('offersContainer');
            
            setTimeout(() => {
                container.innerHTML = '';
                
                DEMO_OFFERS.forEach(offer => {
                    const offerCard = createOfferCard(offer);
                    container.appendChild(offerCard);
                });
            }, 1000);
        }
        
        function createOfferCard(offer) {
            const card = document.createElement('div');
            card.className = 'offer-card';
            
            const typeColor = offer.type === 'sell' ? 'text-success' : 'text-primary';
            const typeIcon = offer.type === 'sell' ? 'arrow-up-circle' : 'arrow-down-circle';
            const typeText = offer.type === 'sell' ? 'VERKAUFT' : 'KAUFT';
            
            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="bi bi-${typeIcon} ${typeColor}"></i>
                            <strong class="${typeColor}">${typeText}</strong>
                            <span class="badge bg-secondary">${offer.user}</span>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Menge:</small><br>
                                <strong>${offer.amount} BTC</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Preis:</small><br>
                                <strong>${offer.price.toLocaleString()} ${offer.currency}</strong>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Zahlungsart:</small><br>
                            <span class="badge bg-outline-light">${offer.method}</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${offer.created}</small><br>
                        <button class="btn btn-warning btn-sm mt-1" onclick="contactUser('${offer.user}')">
                            <i class="bi bi-chat"></i> Kontakt
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function loadMembers() {
            const container = document.getElementById('membersContainer');
            const countBadge = document.getElementById('memberCount');
            
            container.innerHTML = '';
            
            DEMO_MEMBERS.forEach(member => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                
                const statusClass = member.status === 'online' ? 'status-online' : 'status-offline';
                const statusIcon = member.status === 'online' ? 'circle-fill' : 'circle';
                
                memberItem.innerHTML = `
                    <i class="bi bi-${statusIcon} ${statusClass}"></i>
                    <div class="flex-grow-1">
                        <small><strong>${member.name}</strong></small><br>
                        <small class="text-muted">${member.lastSeen}</small>
                    </div>
                `;
                
                container.appendChild(memberItem);
            });
            
            countBadge.textContent = DEMO_MEMBERS.length;
        }
        
        function updateUserBadge() {
            const userBadge = document.getElementById('userBadge');
            
            // Find user name from members list or generate from npub
            const userMember = DEMO_MEMBERS.find(m => m.npub === currentUser.npub);
            const userName = userMember ? userMember.name : 'User_' + currentUser.npub.substring(5, 10);
            
            userBadge.textContent = userName;
        }
        
        function showRequestAccess() {
            const modal = new bootstrap.Modal(document.getElementById('requestModal'));
            modal.show();
        }
        
        function handleAccessRequest(event) {
            event.preventDefault();
            
            const npub = document.getElementById('requestNpub').value.trim();
            const message = document.getElementById('requestMessage').value.trim();
            const contact = document.getElementById('requestContact').value.trim();
            
            // Validate npub
            if (!npub.startsWith('npub1') || npub.length !== 63) {
                alert('Ung√ºltiges npub Format!');
                return;
            }
            
            // Send request to admin (this would be implemented with Nostr DM)
            console.log('üìù Access request:', { npub, message, contact });
            
            alert('‚úÖ Anfrage gesendet! Der Admin wird sich melden.');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('requestModal'));
            modal.hide();
        }
        
        function createOffer(type) {
            alert(`üöß "${type === 'sell' ? 'Verkaufen' : 'Kaufen'}" Interface wird geladen...`);
        }
        
        function contactUser(userName) {
            alert(`üí¨ √ñffne Chat mit ${userName}...`);
        }
        
        function logout() {
            if (confirm('Wirklich ausloggen?')) {
                localStorage.removeItem('userNpub');
                currentUser = null;
                
                document.getElementById('groupInterface').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
                
                // Clear form
                document.getElementById('nsecInput').value = '';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('successMessage').style.display = 'none';
            }
        }
    </script>

    <!-- üì± SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
